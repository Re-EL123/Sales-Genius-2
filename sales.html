<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS Sales</title>
<link rel="stylesheet" href="css/style.css">
<style>
main { padding: 20px; max-width: 1000px; margin: auto; }
#product-buttons { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
#current-sale { display:flex; flex-wrap:wrap; gap:20px; margin-bottom:20px; background:#f0faff; padding:15px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
#current-sale > div { flex:1 1 200px; display:flex; flex-direction:column; }
#current-sale label { font-weight:bold; margin-bottom:5px; }
#current-sale input, #current-sale select { padding:8px; border-radius:5px; border:1px solid #ccc; }
button { padding:10px 20px; background:#00bfff; color:white; border:none; border-radius:5px; cursor:pointer; margin-top:10px; transition:0.3s; }
button:hover { background:#009acd; transform:scale(1.05); }
table { width:100%; border-collapse: collapse; margin-top:15px; }
th, td { border:1px solid #ccc; padding:5px; text-align:center; }
</style>
</head>
<body>
<header style="display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#00bfff; color:white;">
    <h1>POS Sales</h1>
    <a href="dashboard.html" style="color:white; text-decoration:none; font-weight:bold;">Back</a>
</header>

<main>
    <div id="product-buttons"></div>

    <h2>Current Sale</h2>
    <div id="current-sale">
        <div>
            <label for="customer-type">Customer</label>
            <select id="customer-type">
                <option value="walkin">Walk-in Customer</option>
                <option value="online">Online Customer</option>
            </select>
        </div>
        <div>
            <label for="customer-email">Customer Email</label>
            <input type="email" id="customer-email" placeholder="Email for receipt">
        </div>
        <div>
            <label for="customer-whatsapp">WhatsApp Number</label>
            <input type="tel" id="customer-whatsapp" placeholder="WhatsApp receipt">
        </div>
        <div>
            <label for="payment-method">Payment Method</label>
            <select id="payment-method">
                <option value="cash">Cash</option>
                <option value="card">Card</option>
                <option value="digital">Digital</option>
            </select>
        </div>
    </div>

    <h2>Cart</h2>
    <table>
        <thead>
            <tr><th>Name</th><th>Price (R)</th><th>Qty</th><th>Total (R)</th><th>Action</th></tr>
        </thead>
        <tbody id="cart-list"></tbody>
    </table>
    <h3>Total: R<span id="total">0</span></h3>
    <button id="checkout-btn">Checkout</button>
</main>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBLD-z9z2Le8DAqYobMkd2kwurgI9B69rY",
  authDomain: "sales-genius-a.firebaseapp.com",
  projectId: "sales-genius-a",
  storageBucket: "sales-genius-a.firebasestorage.app",
  messagingSenderId: "443916526137",
  appId: "1:443916526137:web:87f76fa73b0a578b17a3e8",
  measurementId: "G-M9C615D3J5"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Redirect if not signed in
auth.onAuthStateChanged(user => {
  if (!user) window.location.href = "index.html";
});

// Cart logic
const cart = [];
const productButtonsDiv = document.getElementById("product-buttons");
const cartList = document.getElementById("cart-list");
const totalEl = document.getElementById("total");

// Load products from Firestore
db.collection("products").orderBy("timestamp", "desc").onSnapshot(snapshot => {
  productButtonsDiv.innerHTML = "";
  snapshot.forEach(doc => {
    const product = doc.data();
    const btn = document.createElement("button");
    btn.textContent = `${product.name} - R${product.price}`;
    btn.onclick = () => addToCart(product);
    productButtonsDiv.appendChild(btn);
  });
});

function addToCart(product) {
  const existing = cart.find(item => item.name === product.name);
  if (existing) {
    existing.qty++;
  } else {
    cart.push({ ...product, qty: 1 });
  }
  renderCart();
}

function renderCart() {
  cartList.innerHTML = "";
  let total = 0;
  cart.forEach((item, index) => {
    const totalPrice = item.price * item.qty;
    total += totalPrice;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${item.name}</td>
      <td>R${item.price.toFixed(2)}</td>
      <td>${item.qty}</td>
      <td>R${totalPrice.toFixed(2)}</td>
      <td><button onclick="removeFromCart(${index})">Remove</button></td>
    `;
    cartList.appendChild(row);
  });
  totalEl.textContent = total.toFixed(2);
}

function removeFromCart(index) {
  cart.splice(index, 1);
  renderCart();
}

// Checkout
document.getElementById("checkout-btn").addEventListener("click", async () => {
  if (cart.length === 0) return alert("Cart is empty!");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const email = document.getElementById("customer-email").value || "N/A";
  const whatsapp = document.getElementById("customer-whatsapp").value || "N/A";
  const payment = document.getElementById("payment-method").value;
  const customerType = document.getElementById("customer-type").value;
  const totalAmount = totalEl.textContent;

  // PDF Header
  let y = 20;
  doc.setFontSize(16);
  doc.text("Sales Genius - Receipt", 14, y);
  doc.setFontSize(10);
  doc.text(`Customer Type: ${customerType}`, 14, y + 10);
  doc.text(`Email: ${email}`, 14, y + 16);
  doc.text(`WhatsApp: ${whatsapp}`, 14, y + 22);
  doc.text(`Payment Method: ${payment}`, 14, y + 28);
  doc.text(`Date: ${new Date().toLocaleString()}`, 14, y + 34);
  y += 45;

  doc.setFontSize(12);
  doc.text("Items:", 14, y);
  y += 8;

  cart.forEach(item => {
    doc.text(`${item.name}  x${item.qty}  -  R${(item.price * item.qty).toFixed(2)}`, 14, y);
    y += 6;
  });

  doc.setFontSize(14);
  y += 10;
  doc.text(`Total: R${totalAmount}`, 14, y);

  // Save receipt
  doc.save(`Receipt_${Date.now()}.pdf`);

  // Save sale record to Firestore
  await db.collection("sales").add({
    customerType,
    email,
    whatsapp,
    payment,
    totalAmount: parseFloat(totalAmount),
    items: cart,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("âœ… Sale completed & receipt generated!");
  cart.length = 0;
  renderCart();
});
</script>
</body>
</html>
